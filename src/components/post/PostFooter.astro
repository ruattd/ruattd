---
import { getPostLastCategory, getSortedPosts } from '@lib/content';
import { getRelatedPosts, hasSimilarityData } from '@lib/content/similarities';
import type { BlogPost } from 'types/blog';
import PostFooterLists from './PostFooterLists';
import RandomPostList from './RandomPostList';
import RelatedPostList from './RelatedPostList';

interface Props {
  post?: BlogPost;
}

const { post } = Astro.props;

// Helper to convert BlogPost to serializable format
const toPostItem = (p: BlogPost) => ({
  slug: p.slug,
  link: p.data.link,
  title: p.data.title,
  categoryName: getPostLastCategory(p).name,
});

// Check if similarity data is available
const hasData = hasSimilarityData();

// Get all posts
const allPosts = await getSortedPosts();
const totalPosts = allPosts.length;

// Calculate how many posts to show on each side
// For <= 10 posts: split evenly (e.g., 8 posts = 4 left + 4 right)
// For > 10 posts: 5 on each side from left/right halves
const leftCount = totalPosts <= 10 ? Math.ceil(totalPosts / 2) : 5;
const rightCount = totalPosts <= 10 ? Math.floor(totalPosts / 2) : 5;

// Prepare post pools for client-side randomization
const allPostItems = allPosts.map(toPostItem);
const leftPool = totalPosts <= 10 ? allPostItems : allPostItems.slice(0, Math.floor(totalPosts / 2));
const rightPool = totalPosts <= 10 ? allPostItems : allPostItems.slice(Math.floor(totalPosts / 2));

// Get related posts if current post is provided and similarity data exists
const relatedPosts = hasData && post ? getRelatedPosts(post, allPosts, 5).map(toPostItem) : [];
---

<div class="tablet:grid-cols-1 grid grid-cols-2 gap-4 px-10 md:px-6">
  {totalPosts <= 10 ? (
    <PostFooterLists client:only="react" allPosts={allPostItems} relatedPosts={relatedPosts} leftCount={leftCount} rightCount={rightCount} />
  ) : (
    <>
      <RandomPostList client:only="react" postsPool={leftPool} count={leftCount} />
      {(hasData || totalPosts <= 10) && <RelatedPostList client:only="react" posts={relatedPosts} fallbackPool={rightPool} fallbackCount={rightCount} startIndex={leftCount + 1} />}
    </>
  )}
</div>
